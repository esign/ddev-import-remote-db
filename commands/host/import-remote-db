#!/usr/bin/env bash

## #ddev-generated: If you want to edit and own this file, remove this line.
# Description: Import a remote MySQL database into DDEV
# Usage: ddev import-remote-db --host <host> --user <user> --database <database> [--port <port>] [--ssh-host <ssh_host>] [--ssh-user <ssh_user>] [--password <password>] [--target-db <target_db>]
# Example: ddev import-remote-db --host db.example.com --user dbuser --database dbname --port 3307 --ssh-host ssh.example.com --ssh-user remoteuser --password mypass --target-db db

set -e


# Default values
PORT=3306
TARGET_DB="db"

# Parse flags
while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    --host)
      HOST="$2"
      shift; shift
      ;;
    --user)
      USER="$2"
      shift; shift
      ;;
    --database)
      DATABASE="$2"
      shift; shift
      ;;
    --port)
      PORT="$2"
      shift; shift
      ;;
    --ssh-host)
      SSH_HOST="$2"
      shift; shift
      ;;
    --ssh-user)
      SSH_USER="$2"
      shift; shift
      ;;
    --password)
      PASSWORD="$2"
      shift; shift
      ;;
    --target-db)
      TARGET_DB="$2"
      shift; shift
      ;;
    -h|--help)
      echo "Usage: $0 --host <host> --user <user> --database <database> [--port <port>] [--ssh-host <ssh_host>] [--ssh-user <ssh_user>] [--password <password>] [--target-db <target_db>]"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: $0 --host <host> --user <user> --database <database> [--port <port>] [--ssh-host <ssh_host>] [--ssh-user <ssh_user>] [--password <password>] [--target-db <target_db>]"
      exit 1
      ;;
  esac
done

EXPORT_DIR=".ddev/import-remote-db"
DUMP_FILE="$EXPORT_DIR/${DATABASE}_remote_dump.sql"



if [ -z "$HOST" ] || [ -z "$USER" ] || [ -z "$DATABASE" ]; then
  echo "Usage: $0 --host <host> --user <user> --database <database> [--port <port>] [--ssh-host <ssh_host>] [--ssh-user <ssh_user>] [--password <password>] [--target-db <target_db>]"
  exit 1
fi

# Ensure export directory exists
mkdir -p "$EXPORT_DIR"

# Create .gitignore in the import-remote-db directory to ignore everything
echo "*" > "$EXPORT_DIR/.gitignore"

dump_and_clean() {
  if [ -n "$SSH_HOST" ]; then
    # SSH-based dump
    SSH_TARGET="$SSH_HOST"
    if [ -n "$SSH_USER" ]; then
      SSH_TARGET="$SSH_USER@$SSH_HOST"
    fi
    echo "Dumping remote database $DATABASE from $USER@$HOST:$PORT via SSH ($SSH_TARGET) to $DUMP_FILE..."
    if [ -n "$PASSWORD" ]; then
      # Password provided, no prompt
      ssh "$SSH_TARGET" "mysqldump -h '$HOST' -P '$PORT' -u '$USER' -p'$PASSWORD' '$DATABASE'" > "$DUMP_FILE"
    else
      # No password provided, prompt
      echo "You will be prompted for the MySQL password on the remote host."
      ssh "$SSH_TARGET" "mysqldump -h '$HOST' -P '$PORT' -u '$USER' -p '$DATABASE'" > "$DUMP_FILE"
    fi
  else
    # Local/within-container dump
    echo "Dumping remote database $DATABASE from $USER@$HOST:$PORT to $DUMP_FILE..."
    if [ -n "$PASSWORD" ]; then
      ddev exec mysqldump -h "$HOST" -P "$PORT" -u "$USER" -p"$PASSWORD" "$DATABASE" > "$DUMP_FILE"
    else
      echo "You will be prompted for the MySQL password."
      ddev exec mysqldump -h "$HOST" -P "$PORT" -u "$USER" -p "$DATABASE" > "$DUMP_FILE"
    fi
  fi

  # Ensure the dump file is synchronized before modifying it
  ddev mutagen sync || true

  # Replace the definer statements from the dump
  echo "Replacing DEFINER statements in $DUMP_FILE..."
  ddev exec "sed -i 's/DEFINER=[^*]*\*/\*/g' $DUMP_FILE"

  # Ensure the dump file is synchronized after modifying it
  ddev mutagen sync || true

  echo "Database dump saved to $DUMP_FILE."
}

echo

if [ -f "$DUMP_FILE" ]; then
  # Show last modified timestamp (macOS/Linux)
  if stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$DUMP_FILE" >/dev/null 2>&1; then
    # macOS/BSD stat
    TS=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$DUMP_FILE")
  elif stat -c '%y' "$DUMP_FILE" >/dev/null 2>&1; then
    # GNU coreutils stat (Linux)
    TS=$(stat -c '%y' "$DUMP_FILE")
  else
    # Fallback: parse from ls -lT output
    TS=$(ls -lT "$DUMP_FILE" 2>/dev/null | awk '{print $6" "$7" "$8" "$9" "$10}')
  fi
  echo "A database dump for '$DATABASE' already exists (last created: $TS)."
  read -p "Would you like to create a fresh dump? (y/n): " OVERWRITE
  if [[ "$OVERWRITE" =~ ^[Yy]$ ]]; then
    dump_and_clean
  else
    echo "Using existing $DUMP_FILE."
  fi
else
  dump_and_clean
fi

echo "Importing $DUMP_FILE into DDEV database '$TARGET_DB'..."
ddev import-db --file="$DUMP_FILE" --target-db="$TARGET_DB"

echo "Import complete."
